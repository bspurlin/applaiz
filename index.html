<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideologue Applaiz</title>
</head>
<script src="/node_modules/ejs/ejs.min.js" ></script>

<script>
  function setMediaMeta (e) {
      if ("mediaSession" in navigator) {
	  navigator.mediaSession.metadata = new MediaMetadata({
	      title: e.title ,
	      artist: e.title ,
	      album: document.querySelector("title").innerHTML,
	      artwork: [{ src: "" }]
	  });
	  navigator.mediaSession.setActionHandler("nexttrack", () => {
	      playAndReset(playlist[e.nextid]);
	  });
	  navigator.mediaSession.setActionHandler("previoustrack", () => {
	      playAndReset(playlist[e.previd]);
          });
	  navigator.mediaSession.setActionHandler("pause", () => {
              audioElement.pause()
          });
	  navigator.mediaSession.setActionHandler("play", () => {
              audioElement.play()
          });
      }
      
  }
  
  function playAndReset (e) {
      let headerrow = document.querySelector("tr.indexhead");
      let playid = e.id;
      document.getElementById(audioElement.audioid).parentElement.nextElementSibling.setAttribute("bgcolor", "#FFFFFF");
      audioElement.audioid =  playid;
      audioElement.nextid = e.nextid;
      audioElement.previd = e.previd;
      audioElement.src = e.src;
      audioElement.title = e.title;
      let el = document.getElementById(playid + 1000);
      el.scrollIntoView({block: "center"});
      //el.previousElement.setAttribute("bgcolor", "#FFFFC0");
      headerrow.childNodes[2].innerHTML = e.title;
      document.getElementById(playid).parentElement.nextElementSibling.setAttribute("bgcolor", "#FFFFC0");
      audioElement.addEventListener("play",(event) => {setMediaMeta(e)});
      console.log(audioElement);
      audioElement.play();
      audioElement.display = "block";
      
  }

</script>

<script>
  let audioElement;
  let obj;  
  let soundfileelements;
  let playlist = {};


  // Create a media player app; render a folder of audio
  // files using JSON fetched from the server.

  window.onload = (event) => {
      audioElement = new Audio();
      audioElement.controls=true;
      audioElement.playsinline=true;
      audioElement.type = "audio/mpeg";
      audioElement.preload = "none";
      audioElement.audioid="0";
      //const params = "d=.";
      const params = {d: "."};
      fetchObj(params)
    }
</script>

<script>

  function fetchObj(params) {
	const options = {
	    mode: 'cors',
	    method: 'POST',
	    headers: {
		"Content-Type": "application/json",
		//'Content-Type':'application/x-www-form-urlencoded'
	    },
	    //body: params
	     body: JSON.stringify(params)
	};
	
	fetch( 'http://floreal:3000', options )
	    .then( response => response.text() )
	    .then( response => {
		obj = JSON.parse(response);
		renderTable(obj);
	    } );

  }
</script>

<script>
  
  function renderTable(obj){

      let template = '<table><tbody>\
<tr class="indexhead"><th class="indexcolicon"><img src="/icons/blank.gif"></th><th class="indexcolname" id="dirname"><%let aa=obj.dirname.split("/")%><%= aa[aa.length - 1]%></th><th></th></tr>\
<tr class="indexbreakrow"><th colspan="2"><hr></th></tr>\
<tr ><td ><img class="dirselector" path=<%= obj.parent %> id="parent-a"  src="/icons/back.gif"></td><td class="dirselector" path=<%= obj.parent %> id="parent">Parent Directory</td></tr>\
<% for (let i = 0; i < obj.directories.length; i++) {\
%><tr ><td class="indexcolicon"><img src="/icons/folder.gif"></td><td id=dirname<%= obj.paths[obj.directories[i]] %> path=<%= obj.path + "." + obj.paths[obj.directories[i]]%> class="dirselector"><%= obj.directories[i]%></td><td></td></tr>\
<%}%>\
<% for (let i = 0; i < obj.files.length; i++) {%>\
    <%let re = /\.(m4a|mp3)$/;%>\
    <%let filename, name, artist, album;%>\
    <%filename = obj.files[i].filename;%>\
    <%if(obj.files[i].title) { name = obj.files[i].title } else {name = filename.replace(re,"")};%>\
    <%if(obj.files[i].album) album = obj.files[i].album;%>\
    <%if(obj.files[i].artist) artist = obj.files[i].artist;%>\
<tr id="<%= i + 1000%>"><td class="indexcolicon" ><img class="soundfile" id="<%= i %>" src="/icons/sound2.gif" filename="<%- filename%>" artist="<%- artist%>" selectiontitle="<%- name%>" album="<%- album%>"><td class="indexcolname"><%- name%></td><td></td></tr>\
<%}%>\
</tbody>\
</table>'

      let html = ejs.render(template, {obj: obj});
      document.getElementById("root").innerHTML = html;
      let direlements = document.getElementsByClassName("dirselector");
      for (e of direlements){
	  e.addEventListener("click",(event) => {
	      let params = {d: event.target.getAttribute("path")};
	      fetchObj(params)
	  })
      }
      soundfileelements =  document.getElementsByClassName("soundfile");
      for (e of soundfileelements) {
	  let serverpath = obj.dirname + "/" + e.getAttribute("filename");
	  let tempAudio = {};
	  tempAudio.src = serverpath;console.log("serverpath: ",serverpath)
	  e.setAttribute("play",e.getAttribute("id"));
	  let i = e.getAttribute("play");
	  tempAudio.id = i*1;
	  tempAudio.nextid = i*1 + 1;
	  if (i == soundfileelements.length -1)  tempAudio.nextid = 0
	  tempAudio.title = e.getAttribute("selectiontitle");
	  playlist[i] = tempAudio;
	  console.log(i, playlist[i]);
	  e.addEventListener("click",(event) => {
              let playid = event.target.getAttribute('play');
              playAndReset(playlist[playid]);
	  });
      }
      audioElement.addEventListener("ended", (event) => {
	  //document.getElementById(event.target.id).previousElement.setAttribute("bgcolor", "#FFFFFF")
	  playAndReset(playlist[event.target.nextid]);
      });
      document.body.insertBefore(audioElement,document.querySelector("root"));
      audioElement.style = "width: 70%;  position: sticky; top: 90%; left: 20%";
      
      
  }

  
</script>
<body>
  <div id="root"></div>  
</body>

</html>
