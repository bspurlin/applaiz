<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideologue Applaiz</title>
    <link rel="stylesheet" href="/css/style.css" type="text/css">
  </head>
<script src="/node_modules/ejs/ejs.min.js" ></script>
<script src="template.js" type="text/javascript"> </script>

<script>

  //Globals
  
  let audioElement;
  let obj;  
  let playlist = [];
  let playlists = {};


  // Create a media player app; render a folder of audio
  // files using a JSON representation of a filesystem
  // fetched from the server.

  window.onload = (event) => {
      audioElement = new Audio();
      audioElement.id = "audio0";
      audioElement.controls=true;
      audioElement.playsinline=true;
      audioElement.type = "audio/mpeg";
      audioElement.preload = "none";
      audioElement.audioid="0";
      audioElement.addEventListener("ended", (event) => {
	  let originaldirname = event.target.dirname;
	  let el = document.getElementById(event.target.nextid + 1000);
	  playAndReset(playlist[event.target.nextid],originaldirname);
	  Highlight(el, originaldirname);
      });
      audioElement.addEventListener("play",(event) => {
	  setMediaMeta(event.target)});
      //const params = "d=.";
      const params = {d: "."};
      fetchObj(params)
    }
</script>

<script>
  function setMediaMeta (e) {
      if ("mediaSession" in navigator) {
	  navigator.mediaSession.metadata = new MediaMetadata({
	      title: playlist[e.audioid].title ,
	      artist: playlist[e.audioid].artist ,
	      album: playlist[e.audioid].album,
	      artwork: [{ src: "" }]
	  });
	  navigator.mediaSession.setActionHandler("nexttrack", () => {
	      playAndReset(playlists[obj.dirname][e.nextid]);
	  });
	  navigator.mediaSession.setActionHandler("previoustrack", () => {
	      playAndReset(playlists[obj.dirname][e.previd]);
          });
	  navigator.mediaSession.setActionHandler("pause", () => {
              audioElement.pause()
          });
	  navigator.mediaSession.setActionHandler("play", () => {
              audioElement.play()
          });
      }
      
  }
  
  function playAndReset (e, dirname = obj.dirname) {
      let headerrow = document.querySelector("tr.indexhead");
      let playid = e.id;
      let re = /#/ig;
      let tmpsrc = "";
      audioElement.audioid =  playid;
      audioElement.nextid = e.nextid;
      audioElement.previd = e.previd;
      tmpsrc = encodeURI(e.src);
      tmpsrc = tmpsrc.replace(re,'%23');console.log("tmpsrc :",tmpsrc);      
      audioElement.src = tmpsrc;
      audioElement.title = e.title;
      audioElement.dirname = dirname;
      headerrow.childNodes[2].innerHTML = e.title;
      if (e.album.length > document.getElementById("headerdirname").innerHTML.length) {
	  document.getElementById("headerdirname").innerHTML = e.album;
      } else {
	  let aa=obj.dirname.split("/");
	  document.getElementById("headerdirname").innerHTML = aa[aa.length - 1]
      }
      audioElement.play();
      audioElement.display = "block";
      
  }

</script>

<script>
  //disable back button
history.pushState(null, document.title, location.href);
window.addEventListener('popstate', function (event)
{
  history.pushState(null, document.title, location.href);
});
</script>


<script>

  function fetchObj(params) {
	const options = {
	    mode: 'cors',
	    method: 'POST',
	    headers: {
		"Content-Type": "application/json",
		//'Content-Type':'application/x-www-form-urlencoded'
	    },
	    //body: params
	     body: JSON.stringify(params)
	};
	
	fetch( document.URL, options )
	    .then( response => response.text() )
	    .then( response => {
		obj = JSON.parse(response);
		renderTable(obj);
	    } );

  }
</script>

<script>
  
  function renderTable(obj){
      let html = ejs.render(mkTempl(0), {obj: obj});
      document.getElementById("root").innerHTML = html;
      document.querySelector("#root").insertBefore(audioElement,document.querySelector("table"))
      let direlements = document.getElementsByClassName("dirselector");
      for (e of direlements){
	  e.addEventListener("click",(event) => {
	      let params = {d: event.target.getAttribute("path")};
	      fetchObj(params)
	  })
      }
      let soundfileelements =  document.getElementsByClassName("soundfile");
      let dirplaylist = [];
      for (let i = 0; i < soundfileelements.length; i++) {
	  let e = soundfileelements[i];
	  let serverpath = obj.dirname + "/" + e.getAttribute("filename");
	  let playlistEntry = {};
	  playlistEntry.src = serverpath;
	  e.setAttribute("play",e.getAttribute("id"));
	  playlistEntry.title = e.getAttribute("selectiontitle");
	  playlistEntry.artist = e.getAttribute("artist");
	  playlistEntry.album = e.getAttribute("album");
	  playlistEntry.id = i;
	  playlistEntry.nextid = i + 1;
	  if (i == soundfileelements.length -1)  playlistEntry.nextid = 0
	  playlistEntry.previd = i - 1 ; 
          if (i == 0) playlistEntry.previd = soundfileelements.length -1;
	  dirplaylist[i] = playlistEntry;
	  e.addEventListener("click",(event) => {
              let playid = event.target.getAttribute('play');
	      playlist = playlists[obj.dirname];
              playAndReset(playlist[playid],obj.dirname);
	      let el = document.getElementById(audioElement.audioid + 1000);
	      Highlight(el, obj.dirname);
	  });
      }
      playlists[obj.dirname] = dirplaylist;
  }

  function Highlight (el, dirname) {
      if (dirname == obj.dirname) {
	  let rows =  document.getElementsByClassName("indexcolname");
	  for (let i = 0; i < rows.length; i++)
	      rows[i].setAttribute("bgcolor", i % 2 ?"#F0F0F0":"#FFFFFF");
	  el.childNodes[3].setAttribute("bgcolor", "#FFFFC0");
	  el.scrollIntoView({block: "center"});
      }	  

  }
  
  
</script>
<body>
  <div id="root"></div>  
</body>

</html>
