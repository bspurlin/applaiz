<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideologue Applaiz</title>
    <link rel="stylesheet" href="/css/style.css" type="text/css">

<script src="/node_modules/ejs/ejs.min.js" ></script>
<script src="template.js" type="text/javascript"> </script>

<script>

  // The search results button will cycle
  // through the searches stored in the session
  
  function sr_cyclic (aa) {
      let i = 0;
      let f = () =>  {return (i++ % aa.length)}
      return f
  }
  
  
  //Globals
  
  let audioElement;
  let globj, g_dirname;  
  let playlist = [];
  let playlists = {};
  let searchresults = [];
  let  sr_cyc =  sr_cyclic(searchresults);
  let dirobj_cache = {};
  
  // Create a media player app; render a folder of audio
  // files using a JSON representation of a filesystem
  // fetched from the server.

  window.onload = (event) => {
      audioElement = document.createElement('audio');
      audioElement.id = "audio0";
      audioElement.controls=true;
      audioElement.playsinline=true;
      audioElement.type = "audio/mpeg";
      audioElement.preload = "none";
      audioElement.audioid="0";
      audioElement.addEventListener("ended", (event) => {
	  let originaldirname = event.target.dirname;
	  let el = document.getElementById(event.target.nextid + 1000);
	  playAndReset(playlist[event.target.nextid],originaldirname);
	  Highlight(el, originaldirname);
      });
      audioElement.addEventListener("play",(event) => {
	  setMediaMeta(event.target);
      } );

      const  startparams = ".";
      let params = {d: startparams};
      fetchObj(params,"/dirobj").then(anobj =>{ renderTable(anobj);
				      dirobj_cache["."] = anobj
				    });
    //      for(x of ["abort","canplay","canplaythrough","ended","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"])audioElement.addEventListener(x,(e) => console.log("audioElement event type: ", e.type));
      document.addEventListener("touchstart", function() {}, true);
    }
</script>

<script>
  function setMediaMeta (e) {
      if ("mediaSession" in navigator) {console.log("mediaSession: ",playlist[e.audioid].title);
	  navigator.mediaSession.metadata = new MediaMetadata({
	      title: playlist[e.audioid].title ,
	      artist: playlist[e.audioid].artist ,
	      album: playlist[e.audioid].album,
	      artwork: [{ src: "/icons/sound2.gif" }]
	  });e.play();
	  navigator.mediaSession.setActionHandler("nexttrack", () => {
	      let el = document.getElementById(e.nextid + 1000);
	      playAndReset(playlists[g_dirname][e.nextid]);
	      Highlight(el);
	  });
	  navigator.mediaSession.setActionHandler("previoustrack", () => {
	      let el = document.getElementById(e.previd + 1000)
	      playAndReset(playlists[g_dirname][e.previd]);
	      Highlight(el);
          });
	  navigator.mediaSession.setActionHandler("pause", () => {
              audioElement.pause()
          });
	  navigator.mediaSession.setActionHandler("play", () => {
              audioElement.play()
          });
      }
      
  }
  
  function playAndReset (e, dirname = g_dirname) {
      let headerrow = document.querySelector("tr.indexhead");
      let playid = e.id;
      let re = /#/ig;
      let tmpsrc = "";
      audioElement.audioid =  playid;
      audioElement.nextid = e.nextid;
      audioElement.previd = e.previd;
      tmpsrc = encodeURI(e.src);
      tmpsrc = tmpsrc.replace(re,'%23');
      console.log("tmpsrc :",tmpsrc);      
      audioElement.src = tmpsrc;
      audioElement.title = e.title;
      audioElement.dirname = dirname;
      document.getElementById("header3").innerHTML = e.title;
      if (e.album.length > document.getElementById("headerdirname").innerHTML.length) {
	  document.getElementById("headerdirname").innerHTML = e.album;
      } else {
	  let aa=g_dirname.split("/");
	  document.getElementById("headerdirname").innerHTML = aa[aa.length - 1]
      }
      audioElement.play();
      let audio_element_attributes = [
	  "audioTracks",
	  "autoplay",
	  "buffered",
	  "controller",
	  "controls",
	  "controlsList",
	  "crossOrigin",
	  "currentSrc",
	  "currentTime",
	  "defaultMuted",
	  "defaultPlaybackRate",
	  "disableRemotePlayback",
	  "duration",
	  "ended",
	  "error",
	  "loop",
	  "mediaGroup",
	  "mediaKeys",
	  "muted",
	  "networkState",
	  "paused",
	  "playbackRate",
	  "preservesPitch",
	  "readyState",
	  "remote",
	  "seekable",
	  "sinkId",
	  "src",
	  "srcObject",
	  "textTracks",
	  "videoTracks",
	  "volume"
      ];
//      for (x of audio_element_attributes) 
//	  console.log(x,"\t",audioElement[x])
      audioElement.display = "block";
      
  }

</script>

<script>
  //disable back button
history.pushState(null, document.title, location.href);
window.addEventListener('popstate', function (event)
{
  history.pushState(null, document.title, location.href);
});
</script>


<script>

  async  function fetchObj(params,url = document.URL) {
      let anobj = {};
	const options = {
	    mode: 'cors',
	    method: 'GET',
	    headers: {
		"Content-Type": "text/html"
		//"Content-Type": "application/json",
		//'Content-Type':'application/x-www-form-urlencoded'
	    },
	    //body: params
	    // body: JSON.stringify(params)
	    //no body in GET method
	};
      url=url + "/" + params.d
      console.log({"Here": {"params":params,"url": url}});
      let response = await  fetch( url );
      //      anobj = JSON.parse(await response.text());
      anobj = await response.text();
      globj = anobj;
    return anobj;
	
  }
</script>

<script>
  
  function renderTable(lobj){
      let html = lobj;
      //let html = ejs.render(mkTempl(0), {obj: lobj});
      document.querySelector("#root").innerHTML = html;
      document.querySelector("body").insertBefore(audioElement,document.querySelector("#ae"));
      let direlements = document.getElementsByClassName("dirselector");
      for (e of direlements){
	  e.addEventListener("click",(event) => {
	      let path = event.target.getAttribute("path")
	      let params = {d: path};
	      if (!dirobj_cache[lobj.path])  dirobj_cache[lobj.path] = lobj;
	      dirobj_cache[lobj.path].scrollpos =  event.target.id;
	      if(dirobj_cache[path]) {
		  lobj = dirobj_cache[path];
		  renderTable(lobj);
	      } else {
		  fetchObj(params,"/dirobj").then(anobj => {
		      renderTable(anobj);
		  })
	      }
	  })
      }

      let backelem = document.getElementById("parent-a");
      backelem.addEventListener("click",(event) => {
//	  if (!dirobj_cache[obj.path])  dirobj_cache[obj.path] = obj;
//	  dirobj_cache[obj.path].scrollpos =  event.target.id;
	  let path = event.target.getAttribute("path")
	  if(dirobj_cache[path]) {
	      lobj = dirobj_cache[path];
	      renderTable(lobj);
	  } else {
	      let params = {d: path};
	      fetchObj(params,"/dirobj").then(anobj => {
		  renderTable(anobj);
	      })
	  }
      })
			       	  
	  
      let tform = document.getElementById("sf");
      tform.addEventListener("submit", (e) => {
	  let inputAll = document.querySelectorAll('.searchTerm');
	  let aa = [];
          inputAll.forEach((x) => { if (x.value) aa.push(x.value) })
	  let params = {s: aa.join(","),p: lobj.path};
	  console.log(params);
	  if (params.s.length > 0) {
	      fetchObj(params,"/search").then(anobj => {
		  if(anobj.files.length == 0 && anobj.directories.length ==0) {
		      alert(params.s + " No Results")
		  } else {
		      searchresults.push(anobj);
		      renderTable(anobj);
		  }
	      }
					     )
	      
	  }
      })

      let soundfileelements =  document.getElementsByClassName("soundfile");
      let dirplaylist = [];
      let l_dirname = document.getElementById("filetable").getAttribute("dirname");
      g_dirname = l_dirname;
      for (let i = 0; i < soundfileelements.length; i++) {
	  let e = soundfileelements[i];
	  let serverpath = l_dirname + "/" + e.getAttribute("filename");
	  let playlistEntry = {};
	  playlistEntry.src = serverpath;
	  e.setAttribute("play",e.getAttribute("id"));
	  playlistEntry.title = e.getAttribute("selectiontitle");
	  playlistEntry.artist = e.getAttribute("artist");
	  playlistEntry.album = e.getAttribute("album");
	  playlistEntry.id = i;
	  playlistEntry.nextid = i + 1;
	  if (i == soundfileelements.length -1)  playlistEntry.nextid = 0
	  playlistEntry.previd = i - 1 ; 
          if (i == 0) playlistEntry.previd = soundfileelements.length -1;
	  dirplaylist[i] = playlistEntry;
	  e.addEventListener("click",(event) => {
              let playid = event.target.getAttribute('play');
	      playlist = playlists[l_dirname];
              playAndReset(playlist[playid],l_dirname);
	      let el = document.getElementById(audioElement.audioid + 1000);
	      Highlight(el, l_dirname);
	  });
      }
      playlists[l_dirname] = dirplaylist;
      if(searchresults.length > 0) {
	  let el = document.getElementById("sr");
	  el.setAttribute("style", "display: inline;" );
	  el.addEventListener("click",(event) => {
	      renderTable(searchresults[sr_cyc()]);
	  })			     
      }
      if(lobj.scrollpos){
	  let e = document.getElementById(lobj.scrollpos);
	  if(lobj.directories && lobj.directories.length > 10){
	      e.scrollIntoView({block: "center", inline: "nearest"});
	  }else {window.scrollTo(0,0)}
      } else {window.scrollTo(0,0)}

  }

  function Highlight (el, dirname = g_dirname) {
      if (dirname == g_dirname) {
	  let rows =  document.getElementsByClassName("indexcolname");
	  for (let i = 0; i < rows.length; i++)
	      rows[i].setAttribute("bgcolor", i % 2 ?"#F0F0F0":"#FFFFFF");
	  el.childNodes[3].setAttribute("bgcolor", "#FFFFC0");
	  el.childNodes[3].focus();
	  el.scrollIntoView({block: "center"});
      }	  

  }
  
</script>
</head>
<body>

    <div id="root"></div>
    <div id="ae"></div>

</body>

</html>
