 <head>
  <title>Index of /shared</title>
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
    var audioElement;
    // Create a media player app from Apache mod_autoindex directory.
    // Requires mod_autoindex directives to function.  See header.html
    window.onload = (event) => {
	audioElement = new Audio();
	audioElement.controls=true;
	//audioElement.webkit-playsinline=true;
	audioElement.playsinline=true;
//	audioElement.class="mediaplayer";
	audioElement.type = "audio/mpeg";
	audioElement.preload = "none";

	document.querySelector("tr.indexhead").childNodes[1].childNodes[0].remove(); //remove the mod_autoindex <a>
	headerrow = document.querySelector("tr.indexhead");
	headerrow.appendChild(document.createElement("th"));

	soundicons = [];
	playlist = {};
	icons = document.getElementsByClassName("indexcolicon"); //These elements generated by mod_autoindex designate
	re = /\.(m4a|mp3)$/;
	//  selection of rows  by '[SND]'
	for(let i =0; i < icons.length; i++) {
	    if (icons[i].childNodes[0].getAttribute("alt") == '[SND]') soundicons.push(icons[i]);
	}
	for(let i =0; i < soundicons.length; i++) {
	    //Create a playlist entry for each sound selection
	    if (soundicons[i].childNodes[0].getAttribute("alt") == '[SND]') {
		let tempAudio = {};
		tempAudio.src = soundicons[i].nextElementSibling.childNodes[0].getAttribute("href");

		soundicons[i].childNodes[0].setAttribute("play",i);

		tempAudio.id = i;
		tempAudio.nextid = i + 1;
		if (i == soundicons.length -1)  tempAudio.nextid = 0 ; //So we have a linked list of sound selections
                tempAudio.previd = i - 1 ; 
		if (i == 0) tempAudio.nextid = soundicons.length -1;


		//Now that we have set up a player with a source, remove the old anchor link,
		//as it causes trouble on mobile devices
		let thisname = decodeURI(tempAudio.src);
		thisname = thisname.replace(re,"");
		soundicons[i].nextElementSibling.childNodes[0].remove();
		soundicons[i].nextElementSibling.innerHTML = thisname;
		// Set an event listener so the next selection will play after the current selection has ended.
		tempAudio.title = thisname;
//		tempAudio.class="mediaplayer";
		
		playlist[i] = tempAudio;

		soundicons[i].addEventListener("click",(event) => {
                    let playid = event.target.getAttribute('play');
                    playAndReset(playlist[playid]);
		});

		
		let tempTD = document.createElement("td");
		
		soundicons[i].parentElement.setAttribute("id",i + 1000);
		soundicons[i].nextElementSibling.insertAdjacentElement("afterend",tempTD);

		// When the play icon is clicked, display and play the media player
		//associated with the event; pause and hide all other video players.
	    }
	}

	audioElement.addEventListener("ended", (event) => {
	    //document.getElementById(event.target.id).previousElement.setAttribute("bgcolor", "#FFFFFF")
	    playAndReset(playlist[event.target.nextid]);
	});

	document.body.insertBefore(audioElement,document.querySelector("table"));
	audioElement.style = "width: 70%;  position: sticky; top: 10%; left: 10%";
	
	//Set the window title and the (fixed, for mobile devices) table header to the directory name
	var href = document.location.href;
	href = decodeURI(href);
	var aa = href.split("/");
	var loc = aa[aa.length -2];
	if(document.querySelector("title").innerHTML !=null) {document.querySelector("title").innerHTML = loc};
	headerrow.childNodes[1].innerHTML = loc;
    };
  </script>
  <script>
    function setMediaMeta (e) {
	if ("mediaSession" in navigator) {
	    navigator.mediaSession.metadata = new MediaMetadata({
		title: e.title ,
		artist: e.title ,
		album: document.querySelector("title").innerHTML,
		artwork: [{ src: "" }]
	    });
	    navigator.mediaSession.setActionHandler("nexttrack", () => {
		playAndReset(playlist[e.nextid]);
	    });
	    navigator.mediaSession.setActionHandler("previoustrack", () => {
		playAndReset(playlist[e.previd]);
            });
	    navigator.mediaSession.setActionHandler("pause", () => {
                audioElement.pause()
            });
	    navigator.mediaSession.setActionHandler("play", () => {
                audioElement.play()
            });
	}

    }

    function playAndReset (e) {
	let playid = e.id;
	audioElement.id = e.id;
	audioElement.nextid = e.nextid;
	audioElement.previd = e.previd;
	audioElement.src = e.src;
	audioElement.title = e.title;
        let el = document.getElementById(playid + 1000);
	el.scrollIntoView({ block: "center", inline: "nearest" });
        //el.previousElement.setAttribute("bgcolor", "#FFFFC0");
        headerrow.childNodes[2].innerHTML = e.title;
	audioElement.addEventListener("play",(event) => {setMediaMeta(e)});
        audioElement.play();
        audioElement.display = "block";
        audioElement.scrollIntoView({ behavior: "smooth", block: "center", inline: "nearest" });                               
    }

  </script>
  
 </head>
