 <head>
  <title>Index of /shared</title>
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
    // Create a media player from Apache mod_autoindex directory.
    // Requires mod_autoindex directives to function.  See header.html
    window.onload = (event) => {
	document.querySelector("tr.indexhead").childNodes[1].childNodes[0].remove(); //remove the mod_autoindex <a>
	headerrow = document.querySelector("tr.indexhead");
	headerrow.appendChild(document.createElement("th"));
	jj = []; //Array of video player ids
	soundicons = [];
	icon = document.getElementsByClassName("indexcolicon"); //These elements generated by mod_autoindex designate
	re = /\.(m4a|mp3)$/;
	//  selection of rows  by '[SND]'
	for(let i =0; i < icon.length; i++) {
	    if (icon[i].childNodes[0].getAttribute("alt") == '[SND]') soundicons.push(icon[i]);
	}
	for(let i =0; i < soundicons.length; i++) {
	    //Create a media player for each sound selection
	    if (soundicons[i].childNodes[0].getAttribute("alt") == '[SND]') {
		let tempVideo = document.createElement("audio");
		let tempSource = document.createElement("source");
		let thisname = soundicons[i].nextElementSibling.childNodes[0].getAttribute("href");

		soundicons[i].childNodes[0].setAttribute("play",i);
		tempVideo.setAttribute("controls","");
		tempVideo.setAttribute("id", i);
		tempVideo.setAttribute("nextid", i +1 ); //So we have a linked list of sound selections
                tempVideo.setAttribute("previd", i - 1 ); // Fix this below for i == 0 and i == soundicons.length
		tempVideo.setAttribute("webkit-playsinline","");
		tempVideo.setAttribute("playsinline","");
		tempVideo.setAttribute("class","mediaplayer");
		jj.push(i);
		tempSource.setAttribute("src",thisname);
		tempSource.setAttribute("type","audio/mpeg" );
		tempVideo.appendChild(tempSource);

		//Now that we have set up a player with a source, remove the old anchor link,
		//as it causes trouble on mobile devices
		thisname = decodeURI(thisname);
		thisname = thisname.replace(re,"");
		soundicons[i].nextElementSibling.childNodes[0].remove();
		soundicons[i].nextElementSibling.innerHTML = thisname;
		// Set an event listener so the next selection will play after the current selection has ended.
		tempVideo.addEventListener("ended", (event) => {
		    event.target.setAttribute("style","display:none");
		    let e = document.getElementById(event.target.getAttribute('nextid'));
		    playAndReset(e);
		});
		let tempTD = document.createElement("td");
		tempTD.setAttribute("hidevideotd",i);
		tempVideo.setAttribute("style","display:none");
		tempTD.appendChild(tempVideo);
		soundicons[i].nextElementSibling.insertAdjacentElement("afterend",tempTD);

		// When the play icon is clicked, display and play the media player
		//associated with the event; pause and hide all other video players.
		soundicons[i].addEventListener("click",(event) => {
		    let playid = event.target.getAttribute('play');
		    let e = document.getElementById(playid);
		    playAndReset(e);
		});
	    }
	}
	// Set the next id of the last id to the first id so
	// selections in the directory will continue to play from the beginning.
	// Similarly with previd
	var e = document.getElementById(jj[jj.length - 1]); 
	if (e !=null) e.setAttribute("nextid",jj[0]);
	e = document.getElementById(jj[0]);
	if (e !=null) e.setAttribute("previd",jj[jj.length - 1]);
	//Set the window title and the (fixed, for mobile devices) table header to the directory name
	var href = document.location.href;
	href = decodeURI(href);
	var aa = href.split("/");
	var loc = aa[aa.length -2];
	if(document.querySelector("title").innerHTML !=null) {document.querySelector("title").innerHTML = loc};
	headerrow.childNodes[1].innerHTML = loc;
    };
  </script>
  <script>
    function setMediaMeta (e) {
	if ("mediaSession" in navigator) {
	    navigator.mediaSession.metadata = new MediaMetadata({
		title: soundicons[e.id].nextElementSibling.innerHTML ,
		artist:document.querySelector("title").innerHTML ,
		album: soundicons[e.id].nextElementSibling.innerHTML,
		artwork: [{ src: "" }]
	    });
	    navigator.mediaSession.setActionHandler("nexttrack", () => {
		let en = document.getElementById(e.getAttribute("nextid"));
		playAndReset(en)
	    });
	    navigator.mediaSession.setActionHandler("previoustrack", () => {
                let en = document.getElementById(e.getAttribute("previd"));
                playAndReset(en)
            });
	    navigator.mediaSession.setActionHandler("pause", () => {
                e.pause()
            });
	    navigator.mediaSession.setActionHandler("play", () => {
                e.play()
            });
	}

    }

    function playAndReset (e) {
	let playid = e.id;
        e.setAttribute("style","display");
        e.parentElement.previousSibling.scrollIntoView({ block: "center", inline: "nearest" });
        e.parentElement.previousSibling.setAttribute("bgcolor", "#FFFFC0");
        //e.scrollIntoView({ behavior: "smooth", block: "center", inline: "nearest" });                               
	for (let x =0; x < jj.length ; x++) {
	    if (jj[x] != playid) {
		let player = document.getElementById(jj[x]);
		player.pause();
		player.setAttribute("style","display:none");
		player.parentNode.previousSibling.setAttribute("bgcolor", "white");
	    }
	}
        headerrow.childNodes[2].innerHTML = e.parentElement.previousSibling.innerHTML;
	e.addEventListener("play",(event) => {setMediaMeta(e)});
        e.play();
    }

  </script>
  
 </head>
